# v0.1.4

Fecha: 2026-02-21

## Estado del backend

Esta version consolida:

1. Ranking por scope (global/pais/ciudad) sobre una sola fuente de rating.
2. Modulo History (timeline auditable).
3. Modulo Analytics (read model materializado, incremental e idempotente).
4. Hardening de performance, estabilidad operativa y seguridad HTTP.
5. Suite de pruebas unificada en `backend/tests`.

## Cambios principales

### 1) Ranking por ubicacion sin duplicar rating

- Se mantiene `user_ladder_state` como fuente oficial unica de rating por `ladder_code + category_id`.
- Endpoint unico:
  - `GET /rankings/{ladder_code}/{category_id}`
- Scopes:
  - Global: sin filtros.
  - Pais: `?country=CO`.
  - Ciudad: `?country=CO&city=Neiva`.
- Filtro 100% SQL en Postgres (sin post-procesado en Python).
- Se agregaron indices para acelerar filtros por ubicacion y orden de ranking.

### 2) Modulo History (timeline auditable)

- Nuevos endpoints:
  - `GET /history/me`
  - `GET /history/users/{user_id}`
  - `GET /history/users/{user_id}/matches/{match_id}`
- Vista timeline paginada y ordenada por `played_at` / `created_at`.
- Alcance por estado:
  - Terceros: solo `verified`.
  - Self: puede consultar `verified`, `pending` o `all`.
- Filtros de lectura:
  - ladder (`HM|WM|MX`)
  - rango de fechas
  - scope de estado
  - club (`club_id`, `club_city`)
- Cada item incluye trazabilidad:
  - `status_reason`
  - `visibility_reason`
  - `ranking_impact` y `ranking_impact_reason`
  - contexto competitivo (equipo foco, rivales, ganador, creador, etc.).

### 3) Modulo Analytics (read model materializado)

- Nuevos endpoints:
  - `GET /analytics/me` (privado)
  - `GET /analytics/users/{user_id}` (publico segun visibilidad del perfil)
- Nuevo read model:
  - `user_analytics_state`
  - `user_analytics_match_applied`
- Actualizacion incremental al verificar un partido (`MatchVerified` en flujo de negocio):
  - aplica solo a los 4 participantes
  - costo O(1) por jugador
- Idempotencia garantizada por `(user_id, match_id)` para evitar doble conteo.
- Rebuild completo disponible:
  - `cd backend && python scripts/rebuild_analytics.py`

### 4) Hardening de estabilidad y seguridad

- Pool de DB configurable (`DB_POOL_SIZE`, `DB_MAX_OVERFLOW`, timeout y recycle).
- `TrustedHostMiddleware` habilitado con `ALLOWED_HOSTS`.
- Security headers configurables con `SECURITY_HEADERS_ENABLED`.
- Parametros de workers para concurrencia (`API_WORKERS`).

## Migraciones incluidas

- `0012_ranking_location_indexes.py`
- `0013_history_timeline_indexes.py`
- `0014_analytics_read_model.py`
- `0015_perf_hardening_indexes.py`

## Verificacion ejecutada

- Suite completa backend:
  - `docker compose exec -T api sh -lc "RUN_API_INTEGRATION=1 pytest -q tests"`
  - Resultado: `15 passed, 3 skipped`.
- Compile check:
  - `python -m compileall backend/app backend/alembic/versions scripts`
- Smoke de performance:
  - ranking, history y analytics bajo `backend/tests/*_performance.py`.
- Seguridad:
  - headers activos en `/health`.
  - rechazo de Host invalido con `400`.

